<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Excel - 5 A√±os de Datos Hist√≥ricos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
        }
        h1 { color: #1f2937; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #6b7280; margin-bottom: 30px; font-size: 16px; }
        .highlight { color: #2563eb; font-weight: bold; }
        .button {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            display: block;
            width: 100%;
            margin: 10px 0;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px rgba(37, 99, 235, 0.4);
        }
        .button:active { transform: translateY(0); }
        .success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            color: #065f46;
            display: none;
        }
        .info {
            background: #dbeafe;
            border-left: 4px solid #2563eb;
            padding: 15px;
            border-radius: 4px;
            margin-top: 30px;
            text-align: left;
            color: #1e3a8a;
            font-size: 14px;
        }
        .preview {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: left;
            font-size: 13px;
        }
        .preview h3 { color: #1f2937; margin-bottom: 10px; font-size: 14px; }
        .sheet-info {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .stat { color: #2563eb; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Generador Excel - 5 A√±os de Historial</h1>
        <p class="subtitle">Genera datos hist√≥ricos completos (2021-2026) con tendencias realistas</p>
        
        <button class="button" onclick="generarExcelConHistorial()">
            üì• Generar Excel con 5 A√±os de Datos
        </button>
        
        <div class="success" id="success">
            ‚úì ¬°Archivo descargado exitosamente!<br>
            <strong>datos_historicos_5a√±os.xlsx</strong> est√° listo para visualizar en el dashboard
        </div>
        
        <div class="preview">
            <h3>üìã Contenido del archivo Excel:</h3>
            <div class="sheet-info">
                <strong>Sheet 1: Accounts</strong> (7 cuentas)<br>
                ‚Ä¢ MRR: $2,800 - $8,500 | ARR total: $415,200<br>
                ‚Ä¢ Diferentes niveles de riesgo para an√°lisis completo
            </div>
            <div class="sheet-info">
                <strong>Sheet 2: Period_Data</strong> (<span class="stat">~147 registros - 21 TRIMESTRES</span>)<br>
                ‚Ä¢ <strong>Per√≠odos:</strong> 2021-Q1 hasta 2026-Q1<br>
                ‚Ä¢ <strong>Tendencias:</strong> Crecimiento, estabilidad y declive<br>
                ‚Ä¢ <strong>M√©tricas:</strong> Expansi√≥n, contracci√≥n, churn, renovaci√≥n
            </div>
            <div class="sheet-info">
                <strong>Sheet 3: NPS_Data</strong> (<span class="stat">~210 respuestas</span>)<br>
                ‚Ä¢ Distribuidas en 5 a√±os (2021-2026)<br>
                ‚Ä¢ Variedad: Promotores, Pasivos, Detractores<br>
                ‚Ä¢ Evoluci√≥n temporal de satisfacci√≥n
            </div>
        </div>
        
        <div class="info">
            <strong>üìä Visualizaciones Disponibles:</strong>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li><strong>Gr√°fico MRR:</strong> Evoluci√≥n de ingresos recurrentes</li>
                <li><strong>Gr√°fico Churn Rate:</strong> Tendencia de p√©rdida de clientes</li>
                <li><strong>Gr√°fico NPS:</strong> Evoluci√≥n de satisfacci√≥n</li>
                <li><strong>Gr√°fico NRR:</strong> Retenci√≥n neta de ingresos</li>
            </ul>
            <p style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #93c5fd;">
                <strong>üéØ C√≥mo usar:</strong><br>
                1. Descarga el archivo Excel<br>
                2. Abre <code>index.html</code><br>
                3. Carga el Excel descargado<br>
                4. ¬°Visualiza 5 a√±os de tendencias hist√≥ricas!
            </p>
        </div>
    </div>

    <script>
        function generarExcelConHistorial() {
            try {
                console.log('üöÄ Generando Excel con 5 a√±os de datos hist√≥ricos...');

                // GENERAR DATOS HIST√ìRICOS DE 5 A√ëOS
                const cuentas = ['ACC001', 'ACC002', 'ACC003', 'ACC004', 'ACC005', 'ACC006', 'ACC007'];
                const a√±os = [2021, 2022, 2023, 2024, 2025, 2026];
                const trimestres = ['Q1', 'Q2', 'Q3', 'Q4'];
                
                // Generar Period_Data hist√≥rico
                let periodDataRows = ['Account_ID,Period,MRR_Starting,Expansion_Revenue,Contraction_Revenue,Churned_Revenue,Clients_Start_Period,Clients_Churned,Clients_Eligible_for_Renewal,Clients_Renewed'];
                
                // Configuraci√≥n de tendencias por cuenta
                const trendConfig = {
                    'ACC001': { mrrBase: 3000, growth: 1.03, health: 'good' },
                    'ACC002': { mrrBase: 5000, growth: 1.04, health: 'excellent' },
                    'ACC003': { mrrBase: 2500, growth: 1.01, health: 'moderate' },
                    'ACC004': { mrrBase: 4000, growth: 1.035, health: 'good' },
                    'ACC005': { mrrBase: 3500, growth: 0.995, health: 'poor' },
                    'ACC006': { mrrBase: 2000, growth: 1.015, health: 'poor' },
                    'ACC007': { mrrBase: 2800, growth: 1.02, health: 'moderate' }
                };
                
                cuentas.forEach(account => {
                    let currentMRR = trendConfig[account].mrrBase;
                    let currentClients = Math.floor(Math.random() * 30) + 50;
                    
                    a√±os.forEach((a√±o) => {
                        const quarterLimit = (a√±o === 2026) ? 1 : 4; // Solo Q1 para 2026
                        
                        for (let q = 0; q < quarterLimit; q++) {
                            const period = `${a√±o}-${trimestres[q]}`;
                            const growth = trendConfig[account].growth;
                            const health = trendConfig[account].health;
                            
                            // Calcular m√©tricas basadas en health
                            let expansion, contraction, churned, clientsChurned, eligible, renewed;
                            
                            if (health === 'excellent') {
                                expansion = Math.floor(currentMRR * 0.08 * (Math.random() * 0.5 + 0.75));
                                contraction = Math.floor(currentMRR * 0.02 * Math.random());
                                churned = 0;
                                clientsChurned = Math.floor(Math.random() * 2);
                                eligible = Math.floor(currentClients * 0.15);
                                renewed = Math.floor(eligible * 0.95);
                            } else if (health === 'good') {
                                expansion = Math.floor(currentMRR * 0.05 * (Math.random() * 0.5 + 0.75));
                                contraction = Math.floor(currentMRR * 0.03 * Math.random());
                                churned = Math.floor(currentMRR * 0.01 * Math.random());
                                clientsChurned = Math.floor(Math.random() * 3);
                                eligible = Math.floor(currentClients * 0.15);
                                renewed = Math.floor(eligible * 0.88);
                            } else if (health === 'moderate') {
                                expansion = Math.floor(currentMRR * 0.03 * (Math.random() * 0.5 + 0.5));
                                contraction = Math.floor(currentMRR * 0.05 * (Math.random() * 0.5 + 0.5));
                                churned = Math.floor(currentMRR * 0.03 * (Math.random() * 0.5 + 0.5));
                                clientsChurned = Math.floor(Math.random() * 6 + 3);
                                eligible = Math.floor(currentClients * 0.15);
                                renewed = Math.floor(eligible * 0.65);
                            } else { // poor
                                expansion = Math.floor(currentMRR * 0.01 * Math.random());
                                contraction = Math.floor(currentMRR * 0.08 * (Math.random() * 0.5 + 0.75));
                                churned = Math.floor(currentMRR * 0.08 * (Math.random() * 0.5 + 0.75));
                                clientsChurned = Math.floor(Math.random() * 15 + 10);
                                eligible = Math.floor(currentClients * 0.15);
                                renewed = Math.floor(eligible * 0.35);
                            }
                            
                            periodDataRows.push(
                                `${account},${period},${Math.floor(currentMRR)},${expansion},${contraction},${churned},${currentClients},${clientsChurned},${eligible},${renewed}`
                            );
                            
                            currentMRR = currentMRR * growth;
                            currentClients = Math.max(30, currentClients - clientsChurned + Math.floor(Math.random() * 5));
                        }
                    });
                });
                
                console.log(`‚úì Generados ${periodDataRows.length - 1} registros de Period_Data`);
                
                // Generar NPS_Data hist√≥rico
                let npsDataRows = ['Account_ID,Period,NPS_Response'];
                const npsRanges = {
                    'ACC001': [8, 9],   // Promotor
                    'ACC002': [9, 10],  // Promotor fuerte
                    'ACC003': [6, 7],   // Pasivo
                    'ACC004': [8, 9],   // Promotor
                    'ACC005': [1, 3],   // Detractor
                    'ACC006': [4, 5],   // Detractor
                    'ACC007': [7, 8]    // Pasivo
                };
                
                cuentas.forEach(account => {
                    a√±os.forEach((a√±o) => {
                        const quarterLimit = (a√±o === 2026) ? 1 : 4;
                        
                        for (let q = 0; q < quarterLimit; q++) {
                            const period = `${a√±o}-${trimestres[q]}`;
                            const [min, max] = npsRanges[account];
                            const numResponses = Math.floor(Math.random() * 2) + 1; // 1-2 respuestas por per√≠odo
                            
                            for (let r = 0; r < numResponses; r++) {
                                const nps = Math.floor(Math.random() * (max - min + 1)) + min;
                                npsDataRows.push(`${account},${period},${nps}`);
                            }
                        }
                    });
                });
                
                console.log(`‚úì Generados ${npsDataRows.length - 1} registros de NPS_Data`);

                // Datos CSV
                const sheets = {
                    'Accounts': `Account_ID,Account_Name,MRR_Current,ARR_Current,Renewal_Date,Total_Licenses,Active_Users,Product_Usage_Percentage,Open_Tickets,Avg_Resolution_Time,Last_Contact_Date
ACC001,Empresa Tech SA,5000,60000,2026-04-20,100,85,78.5,2,2.5,2026-02-15
ACC002,Digital Solutions Inc,8500,102000,2026-06-20,200,140,92,1,1.8,2026-02-18
ACC003,Cloud Services Ltd,3200,38400,2026-03-10,75,42,52.5,6,4.8,2025-12-20
ACC004,Innovation Labs,6800,81600,2026-05-20,150,120,88.7,3,3.1,2026-02-12
ACC005,Global Ventures,4500,54000,2026-07-20,120,35,28.5,12,8.2,2025-08-10
ACC006,Startup Innovate,2800,33600,2026-02-28,60,25,38.0,9,7.2,2025-11-05
ACC007,Enterprise Plus,3800,45600,2026-04-15,100,70,68.5,4,3.8,2026-02-10`,
                    
                    'Period_Data': periodDataRows.join('\n'),
                    'NPS_Data': npsDataRows.join('\n')
                };

                // Cargar SheetJS desde CDN
                if (typeof XLSX === 'undefined') {
                    console.log('Cargando SheetJS...');
                    const script = document.createElement('script');
                    script.src = 'https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js';
                    script.onload = function() {
                        console.log('SheetJS cargado, generando...');
                        generarArchivo(sheets);
                    };
                    script.onerror = function() {
                        console.error('Error cargando CDN primario, intentando alternativo...');
                        const scriptAlt = document.createElement('script');
                        scriptAlt.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
                        scriptAlt.onload = function() {
                            console.log('SheetJS alternativo cargado');
                            generarArchivo(sheets);
                        };
                        scriptAlt.onerror = function() {
                            alert('‚ùå No se pudo cargar la librer√≠a.\n\n‚úì Soluci√≥n:\nVerifica tu conexi√≥n a internet');
                        };
                        document.head.appendChild(scriptAlt);
                    };
                    document.head.appendChild(script);
                } else {
                    generarArchivo(sheets);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }

        function generarArchivo(sheets) {
            try {
                const wb = XLSX.utils.book_new();

                // Procesar cada sheet
                for (const [sheetName, csvData] of Object.entries(sheets)) {
                    const rows = csvData.trim().split('\n').map(row => {
                        // Parser CSV simple
                        const result = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let i = 0; i < row.length; i++) {
                            const char = row[i];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                result.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current.trim());
                        
                        // Convertir n√∫meros
                        return result.map(val => {
                            const num = parseFloat(val);
                            return !isNaN(num) && val !== '' ? num : val;
                        });
                    });

                    const ws = XLSX.utils.aoa_to_sheet(rows);
                    
                    // Ajustar anchos de columna
                    const colCount = rows[0].length;
                    ws['!cols'] = Array(colCount).fill({ wch: 18 });
                    
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    console.log(`‚úì Sheet "${sheetName}" creado (${rows.length - 1} filas)`);
                }

                // Descargar archivo
                XLSX.writeFile(wb, 'datos_historicos_5a√±os.xlsx');
                console.log('‚úÖ Excel generado exitosamente con datos hist√≥ricos');

                // Mostrar mensaje de √©xito
                const successEl = document.getElementById('success');
                successEl.style.display = 'block';
                setTimeout(() => {
                    successEl.style.display = 'none';
                }, 10000);

            } catch (error) {
                console.error('Error generando archivo:', error);
                alert('‚ùå Error al generar Excel:\n' + error.message);
            }
        }

        // Verificar estado al cargar
        window.addEventListener('load', function() {
            console.log('‚úì Generador de datos hist√≥ricos listo');
        });
    </script>
</body>
</html>
